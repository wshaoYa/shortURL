
# 项目背景

公司内部有很多需要发送链接的场景，业务侧的链接通常会⽐较⻓，在发送短信、IM⼯具发送消息、push等场景下⻓链接有许多劣势。需要⼀个短链接服务满⾜各业务线的使⽤。

⼀个⽤于公司内部营销短信和App push的短链接服务，包含转链、存储、链接跳转等功能。

- 提供转链接口
- 后续⽀持提供点击的统计数据报表

# 需求描述

1. 输⼊⼀个⻓⽹址得到⼀个唯⼀的短⽹址。

2. ⽤户点击短⽹址能够正常跳转到对应的⽹址。

3. 为了保证业务的延续性，短⽹址⻓期有效。

# **短链接原理**

⻓链接 → 短链接

![image-20241015160509236](https://s2.loli.net/2024/10/15/QVUGSFmw5jAd8pC.png)

查看短链接

![image-20241015160516332](https://s2.loli.net/2024/10/15/CHt3igJ7TnXb65E.png)

## 短链生成方式

基于发号器/自增序列

每收到⼀个转链请求，就使⽤发号器⽣成递增（1、2、3、4...以此递增）的序号，然后将该序号转为**62**进制，最后拼接到短域名后即得到最终的短链。

例如：

序号 1234567890 转为62进制为 1ly7vk ，再拼接到短域名后 q1mi.cn/1ly7vk 。

**优势：**

- ⽣成的id递增

- 理论上容量⾜够满⾜现实需求

**劣势：**

- ⾼并发下的发号器设计是难点。



**发号器实现⽅式**

常⻅的发号器实现⽅式有以下⼏种：

1. 基于uuid实现

优势：不会重复、性能好

劣势：数字太⼤了，32位16进制数

2. 基于redis实现发号器

优势：⾼性能

劣势：需搭建⾼可⽤架构并考虑持久化

3. 基于雪花算法的分布式ID⽣成器

优势：⾼性能、⾼可⽤

劣势：实现复杂，依赖时钟

4. 基于MySQL⾃增主键的发号器

优势：简单、可靠

劣势：依赖MySQL，性能会成为瓶颈，但可通过分⽚扩展可⽤性





本项目这⾥采⽤的是基于MySQL数据库主键做发号器的⽅案。借助REPLACE 的⼯作⽅式，其与 INSERT 完全相同，只是如果表中的旧⾏与新⾏在PRIMARYKEY 或 UNIQUE 索引具有相同的值，则在插⼊新⾏之前删除旧⾏。

这就让我们能够在数据库中的单⾏位置进⾏⾃动更新，并获得⼀个新的⾃动递增的主 ID。

# 项目架构

# ![image-20241015161458797](https://s2.loli.net/2024/10/15/HvxmF3G5DiEKaWU.png)

![image-20241015162359984](https://s2.loli.net/2024/10/15/2sZlhUf1CWHztGo.png)

# 主要模块

根据需求分析，可以将需求拆分为**转链模块**、**存储**和**访问链接模块**。

## **转链模块**

1. 相同的⻓链要转为同⼀个短链

2. ⽣成的短链为尽量短的字符。 例如q1mi.cn/p6Yo7Z

**注意：**

1. 需要避免某些不合适的词（例如 f**k 、 stupid ）

2. 避免⽣成的短链出现某些特殊含义的词 version 、 health 等

3. 避免循环转链（把已经是短链的再拿来转短链）

## **存储**

1. 保存原始⻓链接与短链接的对应关系

2. 能够根据短链接查找到原始的⻓链接

## **查看链接模块**

1. 根据短链查询到⻓链后返回重定向响应。

2. 后续数据报表需求可能需要采集并统计请求头数据。

# 分片部署

为了避免单点故障，我们可以将我们的ID⽣成器分成奇数和偶数两部分，分别部署在两个MySQL服务器。

两个数据表配置不同的 auto-increment-offset ， server1 ⽣成1、3、5、7、9...， server2 ⽣成2、4、6、

8...。

```
server1:
auto-increment-increment = 2
auto-increment-offset = 1
server2:
auto-increment-increment = 2
auto-increment-offset = 2
```

# 技术要点

- 基于MySQL主键实现了高可用的发号器组件。

- 查看链接服务增加Redis缓存，采⽤布隆过滤器防⽌缓存穿透，使用singleflight防⽌缓存击穿。

- 在转链时进⾏可访问、防⽌循环转链、特殊词过滤等校验处理。

# 个人收获

- 熟悉了常⽤的发号器设计⽅案，能够结合实际情况选择最适合的⽅案。

- 熟悉了go-zero框架的使⽤，对Go语⾔操作MySQL和Redis都更加熟悉。

- 锻炼了⾃⼰的⾃主学习能⼒，积累了项⽬设计和开发的经验。